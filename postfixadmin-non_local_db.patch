--- ./functions.inc.php.org	2008-01-17 16:38:55.000000000 +0100
+++ ./functions.inc.php	2008-01-17 16:39:42.000000000 +0100
@@ -126,10 +126,12 @@
 function escape_string ($string)
 {
    global $CONF;
+   $link = db_connect ();
+
    if (get_magic_quotes_gpc () == 0)
    {
-      if ($CONF['database_type'] == "mysql")  $escaped_string = mysql_real_escape_string ($string);
-      if ($CONF['database_type'] == "mysqli")  $escaped_string = mysqli_real_escape_string ($string);
+      if ($CONF['database_type'] == "mysql")  $escaped_string = mysql_real_escape_string ($string, $link);
+      if ($CONF['database_type'] == "mysqli")  $escaped_string = mysqli_real_escape_string ($link, $string);
       if ($CONF['database_type'] == "pgsql")  $escaped_string = pg_escape_string ($string);
    }
    else
